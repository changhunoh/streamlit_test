# -*- coding: utf-8 -*-
"""app.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1K4ZLdGiH5Lq_X3zZFoAqV5tusmuk8pcX
"""

# app.py
import streamlit as st
st.set_page_config(page_title="ì£¼ì‹ ì¶”ì²œ ì—ì´ì „íŠ¸", layout="centered")
import pandas as pd
import sys
import os

# --- LangGraph ë°±ì—”ë“œ ëª¨ë“ˆ ì„í¬íŠ¸ ---
# app.pyì™€ langgraph_backend.pyê°€ ê°™ì€ í´ë”ì— ìˆë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.
# ë§Œì•½ ë‹¤ë¥¸ í´ë”ì— ìˆë‹¤ë©´ sys.path.append() ê²½ë¡œë¥¼ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.
current_dir = os.path.dirname(os.path.abspath(__file__))
if current_dir not in sys.path:
    sys.path.append(current_dir)

try:
    # langgraph_backend.py íŒŒì¼ì—ì„œ í•„ìš”í•œ ê²ƒë“¤ì„ ì„í¬íŠ¸í•©ë‹ˆë‹¤.
    from langgraph_backend import graph, StockRecommendationState, nasdaq_stocks_df
    st.success("LangGraph ë°±ì—”ë“œ ëª¨ë“ˆ ì„í¬íŠ¸ ì„±ê³µ!")
except ImportError as e:
    st.error(f"LangGraph ë°±ì—”ë“œ ëª¨ë“ˆ ì„í¬íŠ¸ ì‹¤íŒ¨: {e}")
    st.info("`langgraph_backend.py` íŒŒì¼ì´ `app.py`ì™€ ê°™ì€ í´ë”ì— ìˆëŠ”ì§€ í™•ì¸í•˜ê±°ë‚˜, `sys.path.append()` ê²½ë¡œë¥¼ ìˆ˜ì •í•˜ì„¸ìš”.")
    st.stop() # ì„í¬íŠ¸ ì‹¤íŒ¨ ì‹œ ì•± ì‹¤í–‰ ì¤‘ì§€
except Exception as e:
    st.error(f"LangGraph ë°±ì—”ë“œ ëª¨ë“ˆ ë¡œë“œ ì¤‘ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ ë°œìƒ: {e}")
    st.stop()

# --- Streamlit Secretsì—ì„œ API í‚¤ ì„¤ì • (Colab userdata ëŒ€ì²´) ---
# Streamlit ì•±ì„ ë°°í¬í•˜ê±°ë‚˜ ë¡œì»¬ì—ì„œ ì•ˆì „í•˜ê²Œ API í‚¤ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ì´ ë°©ë²•ì„ ê¶Œì¥í•©ë‹ˆë‹¤.
# 1. í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— .streamlit/secrets.toml íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.
# 2. secrets.toml íŒŒì¼ì— ë‹¤ìŒê³¼ ê°™ì´ API í‚¤ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤:
#    GOOGLE_API_KEY = "YOUR_GOOGLE_API_KEY"
#    SERPAPI_API_KEY = "YOUR_SERPAPI_API_KEY"
# 3. ì½”ë“œì—ì„œ os.environ.get() ëŒ€ì‹  st.secrets[]ë¥¼ ì‚¬ìš©í•˜ë„ë¡ langgraph_backend.pyë¥¼ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.
#    (í˜„ì¬ langgraph_backend.pyëŠ” os.environ.get()ì„ ì‚¬ìš©í•˜ë¯€ë¡œ, í™˜ê²½ ë³€ìˆ˜ë¥¼ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.)
#    ì˜ˆ: export GOOGLE_API_KEY="your_key"
#        export SERPAPI_API_KEY="your_key"
#    ë˜ëŠ”, Streamlit Secretsë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ langgraph_backend.pyì˜ API í‚¤ ë¡œë“œ ë¶€ë¶„ì„
#    st.secrets.get()ìœ¼ë¡œ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤. ì—¬ê¸°ì„œëŠ” os.environ.get()ì„ ìœ ì§€í•©ë‹ˆë‹¤.

st.title("ğŸ“ˆ AI ì£¼ì‹ ì¶”ì²œ ì—ì´ì „íŠ¸")
st.markdown("ê¶ê¸ˆí•œ ì£¼ì‹ ê´€ë ¨ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì‹œë©´ AIê°€ ì¢…ëª©ì„ ì¶”ì²œí•´ ë“œë¦½ë‹ˆë‹¤.")

# ì‚¬ìš©ì ì…ë ¥ ë°›ê¸°
user_query = st.text_input(
    "ì–´ë–¤ ì¢…ë¥˜ì˜ ì£¼ì‹ì— íˆ¬ìí•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”? (ì˜ˆ: 'ê¸°ìˆ ì£¼ì— íˆ¬ìí•˜ê³  ì‹¶ì–´', 'ì‹œê°€ì´ì•¡ì´ í° ì—ë„ˆì§€ ì£¼ì‹ ì¶”ì²œí•´ ì¤˜')",
    placeholder="ì˜ˆ: 'ì¹œí™˜ê²½ ì—ë„ˆì§€ ê´€ë ¨ ì£¼ì‹ ì¶”ì²œí•´ ì¤˜' ë˜ëŠ” 'ì‚¼ì„±ì „ìì— ëŒ€í•´ ì•Œë ¤ì¤˜'"
)

# ì¶”ì²œ ë²„íŠ¼
if st.button("ì£¼ì‹ ì¶”ì²œë°›ê¸°"):
    if not user_query:
        st.warning("ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!")
    else:
        with st.spinner("AIê°€ ì£¼ì‹ ì •ë³´ë¥¼ ë¶„ì„í•˜ê³  ì¶”ì²œì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš” (ìµœëŒ€ 1-2ë¶„ ì†Œìš”)."):
            try:
                # LangGraph ì´ˆê¸° ìƒíƒœ ì„¤ì •
                # nasdaq_stocks_dfëŠ” langgraph_backend.pyì—ì„œ ì´ë¯¸ ë¡œë“œëœ ì „ì—­ ë³€ìˆ˜ì…ë‹ˆë‹¤.
                init_state = StockRecommendationState(
                    messages=[],
                    query=user_query,
                    recommendations=[],
                    feedback="",
                    iteration_count=0,
                    formatted_output="",
                    news={},
                    judge_score=0.0,
                    judge_reason="",
                    all_available_stocks_df=nasdaq_stocks_df,
                    filtered_nasdaq_stocks_df=pd.DataFrame() # ì´ˆê¸°ì—ëŠ” ë¹ˆ DataFrame
                )

                # LangGraph ì—ì´ì „íŠ¸ ì‹¤í–‰
                final_state = graph.invoke(init_state)

                # ê²°ê³¼ í‘œì‹œ
                st.subheader("ğŸŒŸ AIì˜ ì£¼ì‹ ì¶”ì²œ ê²°ê³¼")
                if "formatted_output" in final_state and final_state["formatted_output"]:
                    st.markdown(final_state["formatted_output"])
                elif "recommendations" in final_state and final_state["recommendations"]:
                    st.json(final_state["recommendations"]) # raw JSON fallback
                else:
                    st.warning("ì¶”ì²œì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì§ˆë¬¸ì„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.")

                st.markdown("---")
                st.subheader("ğŸ” ì—ì´ì „íŠ¸ ì‹¤í–‰ ìƒì„¸")
                st.write(f"**ì´ ë°˜ë³µ íšŸìˆ˜:** {final_state.get('iteration_count', 0)}")
                st.write(f"**LLM Judge ìµœì¢… ì ìˆ˜:** {final_state.get('judge_score', 0.0):.2f}")
                st.write(f"**LLM Judge ìµœì¢… ì´ìœ :** {final_state.get('judge_reason', 'ì—†ìŒ')}")

            except Exception as e:
                st.error(f"ì£¼ì‹ ì¶”ì²œ ì—ì´ì „íŠ¸ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
                st.exception(e) # ìì„¸í•œ ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤ í‘œì‹œ

st.sidebar.header("ì •ë³´")
st.sidebar.info(
    "ì´ ì•±ì€ LangGraphë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ AI ì£¼ì‹ ì¶”ì²œ ì—ì´ì „íŠ¸ ë°ëª¨ì…ë‹ˆë‹¤.\n\n"
    "Yahoo Finance, FinanceDataReader, SerpApië¥¼ ì‚¬ìš©í•˜ì—¬ ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ í™œìš©í•©ë‹ˆë‹¤."
)
st.sidebar.markdown("[GitHub ë¦¬í¬ì§€í† ë¦¬](https://github.com/your-repo-link) (ë§Œì•½ ìˆë‹¤ë©´)")
